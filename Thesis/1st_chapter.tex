\chapter{Az emulátorok és a Nintendo Game Boy}
\section{Az emulátorokról}
\noindent Az utóbbi évtizedekben végbement -- és jelenleg is tartó -- technikai fejlõdés következ\-mé\-nyeként rendkívül gyors a technológiai elavulás. Ennek következményeképp az eszközök életciklusa megrövidül, értékük rohamosan csökken. Gyakran elõfordul azonban, hogy szükség van a régi \textit{legacy} rendszerekre, vagy elengedhetetlen a visszafelé kompatibilitás, esetleg szeretnénk az adott hardvert a számítástechnikai jelentõsége miatt valamilyen formában megõrizni, használhatóvá tenni. Az emulátorok ezekre a problémákra i\-gyek\-sze\-nek megoldást kínálni -- persze rendkívül sok egyéb felhasználási terület mellett.
\subsection{Az emulátor fogalma}

Definíció szerint olyan hardvert vagy szoftvert nevezünk \textbf{emulátornak}, amely lehetõvé teszi, hogy egy számítástechnikai rendszer (szokás ezt \textit{host}-nak nevezni) úgy viselkedjen, mint egy másik számítástechnikai rendszer (ez pedig a \textit{guest}). Jellemzõen az emulátor a \textit{host} rendszer számára teszi lehetõvé olyan szoftver futtatását vagy periféria használatát, amely a \textit{guest} rendszerhez lett kifejlesztve. Röviden megfogalmazva az emulátor egy olyan hardver vagy szoftver, ami egy másik eszközt vagy programot emulál, imitál.

\subsection{Az emulátorok típusai}

Az emulátorok többsége csak a hardver architektúrát emulálja -- ha operációs rendszer vagy egyéb szoftver is szükséges az emuláláshoz, akkor azt is biztosítani kell. Ebben az esetben az operációs rendszert és a szoftvert \textit{interpretálni} (értelmezni) fogja az emulátor. A gépi kód \textit{interpreteren} kívül azonban az emulátornak tartalmaznia kell a \textit{guest} hardver minden lehetséges jellemzõjét, és viselkedését is virtuálisan: ha például egy adott me\-mó\-ri\-a\-hely\-re való írás befolyásolja azt, hogy mi jelenik meg a képernyõn, úgy azt is emulálni kell. Habár lehetne az emulációt extrém részletességgel, atomi szinten végezni -- például az áramkör adott részei által kibocsátott pontos feszültségingadozás emulálásával, stb. --, ez egyáltalán nem gyakori, az emulátorok általában megállnak a dokumentált hardver specifikáció, és digitális logika szimulációjának szintjén. \\
Némely hardver hatékony emulálásához extrém pontosság szükséges: az óraciklusokat, nem dokumentált jellemzõket, kiszámíthatatlan analóg elemeket, és \textit{bugokat} mind-mind implementálni kell. A klasszikus otthoni számítógépek esetében (például a Commodore 64) ez hatványozottan igaz, mert az ezekre a hardverekre írt szoftverek gyakran ki\-hasz\-nál\-tak alacsony szintû programozási trükköket, melyeket fõként a videojáték programozók és a \textit{demoscene}\footnote{A \textit{demoscene} nemzetközi underground számítástechnikai szubkultúra, amelynek célja különbözõ számítógépes digitális mûvészeti alkotások (\textit{demók}) készítése.} fedeztek fel. \\
Ezzel szemben léteznek azonban olyan platformok, amelyek alig használják a közvetlen hardver elérést, jó példa erre a PlayStation Vita. Ezekben az esetekben elég egy kom\-pa\-ti\-bi\-li\-tási réteget megvalósítani, amely a \textit{guest} rendszer rendszerhívásait fordítja le a \textit{host} rendszer hívásaira.

\subsection{Az emulátorok jövõje}

A videojáték-konzol emulátorok világa, illetve az emulátor fejlesztõ közösség helyzete igen érdekes. Az egyik oldalról megvizsgálva azt tapasztalhatjuk, hogy egyre nagyobb népszerûségnek örvendõ területrõl van szó. Ami a másik oldalt illeti -- a helyzet nagyon homályos. Újabb és újabb konzolok jelennek meg, egyre rövidebb életciklussal és egyre bonyolultabb architektúrával. Jól mutatja ezt a PlayStation 3 példája: 12 éve, 2006-ban jelent meg, és tökéletes emulátor még nem készült hozzá. A közösség nem tudja tartani a tempót a bonyolultság, és a rövid életciklusokból adódó szoros határidõk miatt. \\
Sokak szerint viszont a jövõben nemhogy nehezebb, hanem inkább könnyebb lesz az emuláció: véleményük szerint a hardver emulációja nem lesz könnyû, viszont az utóbbi években nagyon sokat javult a szoftverek minõsége és tisztasága egyaránt. A játékfej\-lesz\-tõk rá vannak kényszerítva az API-k (\textit{Application Programming Interface} -- al\-kal\-ma\-zás\-prog\-ra\-mozási interfész) használatára a hardver \textit{bugjainak} kihasználása és a trükközés helyett, és ez lehetõséget adhat az API-kon alapuló emuláció elterjedése felé. \\
Fontos megemlíteni egy 2010-ben indult közösségi projektet, a RetroArch-ot, amely a videojáték konzol emulátorok számára biztosít egy prezentációs réteget, ún. \textit{frontend}-et, amely egybefogja, és használhatóvá, futtathatóvá teszi a vele kompatibilis emulátorokat. Ez a megoldás nagyban megkönnyíti a felhasználók életét, hiszen több tucatnyi rendszer e\-mu\-lá\-torát érhetik el egyetlen felületen keresztül, és a fejlesztõk számára is jelent egy enyhe szabványosítási törekvést. \\
Ahogy a fenti két vélemény, és a RetroArch példája is mutatja, sokan sokféleképpen vélekednek az emulátorfej\-lesz\-tés jövõjérõl, nem beszélve a frissen induló közösségi pro\-jek\-tek\-rõl -- szinte biztosan kijelenthetõ, hogy ez a terület nem fog egyhamar megszûnni.


\section{Nintendo Game Boy}

% \includegraphics[scale=0.4]{./Resources/placeholder.eps}

\noindent Egy emulátor fejlesztési folyamatának bemutatására a Nintendo Game Boy tökéletes példa több szempontból is. Elsõsorban széleskörûen ismert, ebbõl adódóan az emulátor fejlesztõi közösség által is jól dokumentált, a hardver szinte az utolsó részletig vissza lett fejtve. Ezekbõl a dokumentációk tehát jó kiindulási alapot nyújtanak. Az is fontos szempont, hogy a hardver a 8 bites érából származik, ami szinte garantálja az egyszerûbb architektúrát (ez persze relatív), így a könnyebb implementálhatóságot. Szintén meg\-em\-lí\-ten\-dõ, hogy a fejlesztõi közösség által készített teszt ROM-ok nagyban segítik a hibakeresést, verifikációt.

\subsection{Története, jelentõsége}

\begin{figure}[h]
    \centering
    \includegraphics[width=1.06\textwidth,trim={1.1cm 0.5cm 0 1cm},clip]{./Resources/gb_logo.eps}
    \caption{\textit{A Nintendo Game Boy logója}}
    \label{fig:gb_logo}
\end{figure}

\noindent A Game Boy egy Nintendo által gyártott hordozható videojáték konzol, amit a nagy\-kö\-zön\-ség számára 1989-ben mutattak be. Ez volt a gyártó elsõ 8 bites kézi konzolja, amihez a játékokat cserélhetõ kazetta formájában (angolul \textit{cartridge}) lehetett megvásárolni. \\
Az okos marketingnek, és a jó Nintendo \textit{brand}-nek köszönhetõen a Game Boy kora leg\-si\-ke\-re\-sebb kézi konzolja lett, annak ellenére, hogy a versenytársaihoz (Atari Lynx, Sega Game Gear) mérten elavult technológiát használt. Ez egyben azt is jelentette, hogy a Game Boy-ban használt alkatrészek olcsóbbak, ismertebbek és kiforrottabbak voltak, mint a riválisoké. A tervezõk alapgondolata az volt, hogy régebbi technológiát használnak fel innovatív módon. A konzol sikerét az olcsósága, az akkumulátor idõtartama, és a platformon elérhetõ rengeteg játék mennyisége és minõsége koronázta meg. Az 1997-ig értékesített 60 milliós példányszám a Game Boy-t a gyártó egyik legsikeresebb termékévé tette. A készülék jellegzetes logója a \ref{fig:gb_logo}-es ábrán látható.

\subsection{Hardver specifikáció}

\noindent A hardver specifikációját két logikai egységre lehet osztani: a Game Boy hardverére és a \textit{cartridge} hardverre. Ugyan ezek együtt alkotnak egészet, hiszen egyik sem használható a másik nélkül, ám technikailag két különálló egységrõl beszélhetünk.

\subsubsection{Game Boy}

\noindent A konzol külseje, és kezelõszervei a \ref{fig:gb_manual}-es ábrán figyelhetõk meg, az általa tartalmazott hardver elemek pedig a következõk\cite{WikiGB}:

\begin{itemize}
  \item \textbf{CPU}: a 8 bites \textit{Zilog Z80}-as CISC-processzor architektúrán alapuló -- annak u\-ta\-sí\-tás\-kész\-le\-tén enyhén módosított változata -- \textit{Sharp LR35902}.
  \item \textbf{RAM}: 8 kB beépített S-RAM
  \item \textbf{VRAM} (video memória): 8 kB beépített
  \item \textbf{ROM}: 256 Byte (Boot ROM-nak fenntartva)
  \item \textbf{Hang}: 2 négyszögjel generátor, 1 programozható 32 mintás 4 bites PCM hullám, 1 fehér zaj, és egy audio bemenet a kazettából. (A külsõ kazetta bemenetet soha egy piacra dobott játék sem használta.) A jack kimeneten keresztül sztereó hangot ad.
  \item \textbf{Kijelzõ}: 166 $\times$ 144 pixel felbontású LCD kijelzõ, mérete átlósan 66 mm.
  \item \textbf{Színpaletta}: 4 árnyalat 2 biten tárolva -- világos zöldtõl a sötét zöldig.
  \item \textbf{Tápellátás}: 4 db AA elem, amely megközelítõleg 14-35 óra játékidõt biztosít.
\end{itemize}

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth, trim={0.4cm 0 0.4cm 0},clip]{./Resources/gb_manual.eps}
    \caption{\textit{A Game Boy és részei}}
    \label{fig:gb_manual}
\end{figure}
\newpage
\subsubsection{Cartridge}

A konzolhoz tartozó játék kazettákat a konzol hátuljába kellett címkével kifelé fordítva becsúsztatni. Ezek a kazetták jól felismerhetõek voltak a jellegzetes (nagyrészt) szürke színükrõl, illetve az elejükre ragasztott, az adott játékot ábrázoló címkéjükrõl, ami a \ref{fig:cartridge}-es ábrán is megfigyelhetõ. A Game Boy-hoz több típusú kazetta volt forgalomban, melyet az indokolt, hogy némely játék nagyobb erõforrást igényelt a futásához. A konzolnak köztudottan kicsi volt a memória mérete, így a játékfejlesztõknek különféle trükköket kellett bevetniük ahhoz, hogy a játékaikat futásra bírják. Erre a problémára a \textit{Memory Bank Controller} alkalmazása volt a megoldás, ennek használatával a fejlesztõk számára nagyobb ROM, illetve \textit{MBC} verziótól függõen nagyobb RAM volt elérhetõ. Az \textit{MBC} részleteirõl és típusairól az egyik késõbbi fejezetben lesz szó.\\
\begin{wrapfigure}{l!}{4.5cm}
    \centering
    \includegraphics[width=4.5cm, trim={0 0.2cm 0 0.2cm},clip]{./Resources/cart_mario.eps}
    \caption{\textit{A Dr. Mario játék kazettája}}
    \label{fig:cartridge}
\end{wrapfigure}
A kazetták többségében volt egy \texttt{CR2025}-ös típusú gombelem is, ami az elmentett játékállások tárolásából adódó erõforrás-ellátásért felelt. Az elem viszont nem tartott örökké -- így mikor hosszú idõ után ugyan, de lemerült, az összes mentett állás elveszett. \\
További érdekesség még a \textit{cartridge}-ekkel kapcsolatban a Nintendo által kifejlesztett korabeli (de meglepõen hatékony) másolásvédelmi és \textit{homebrew}\footnote{A \textit{homebrew} fogalmat azokra a videojátékokra vagy egyéb szoftverekre használjuk, amelyeket a fogyasztói réteg készít el a zárt forrású hardverekre, platformokra -- tehát nincsenek kapcsolatban a célhardver gyártójával.}-fejlesztõket kizáró mechanizmus. Annak érdekében hogy a kazettákat ne lehessen lemásolni és így terjeszteni, illetve a gyártóval kapcsolatba nem lépõ hobbi fejlesztõk ne tudjanak játékot kiadni a platformra, a Nintendo szokatlan, de hatékony megoldást választott. Amikor a felhasználó behelyezi a kazettát a Game Boy-ba, és bekapcsolja azt, akkor a Boot ROM lefutását követõen a játék csak akkor indul el, ha a játék kódjában megtalálhatók a Nintendo logót alkotó byte-ok. Ha ez hiányzik, akkor a játék nem fog futni. A trükk az, hogy ugyan a törvény nem tiltja, hogy játékokat fejlesszenek a hobbi fejlesztõk a konzolra, viszont a Nintendo logó felhasználását szerzõi jogi törvények védik. Így, ha a hobbi fejlesztõ terjesztené a játékát, akkor be kell ágyaznia a Nintendo logót a kódba, amivel viszont szerzõi jogi szabályokat sért. Ezzel a Nintendo elérte, hogy a konzolra kiadott játékok minõsége magas legyen, hiszen minden játék kiadásáról végsõ soron õk döntöttek.\cite{GBTalk}

\subsection{Boot ROM}

\begin{figure}[h!]%
    \centering
    \subfloat[\textit{A Sharp LR35902 CPU}]{{\includegraphics[height=5.5cm]{./Resources/Boot_ROM_overview.eps} }}%
    \qquad
    \subfloat[\textit{A Boot ROM bitjei}]{{\includegraphics[height=5.5cm]{./Resources/Boot_ROM_zoom.eps} }}%
    \caption{\textit{A CPU és a Boot ROM}}%
    \label{fig:example}%
\end{figure}

A Nintendo Game Boy Boot ROM-ja végzi a hardver elindulását követõ inicializáló folyamatokat, illetve az elõzõ részben említett másolásvédelmi eljárást. A ROM pontos tartalma egészen 2003-ig ismeretlen volt -- ekkor viszont egy \textit{Neviksti} nevû felhasználó publikálta a \textit{cherryroms.com} fórumára a program teljes változatát. \textit{Neviksti} azt is leírta, hogy hogyan sikerült visszafejtenie a kódot: a Game Boy processzor chip tetejének le\-sze\-dé\-se után mikroszkóppal megvizsgálta az áramkört, majd amint megtalálta a Boot ROM lehetséges helyét (256 kB ROM van elkülönítve erre a CPU-ban), lefényképezte azt, majd bitrõl bitre haladva rekonstruálta a bináris állományt. A teljes processzor madártávlati nézete a \ref{fig:example}-es ábrának \textit{(a)} részén látható, a belenagyított \textit{(b)} ábrán pedig az áramkör Boot ROM-ot tároló része szerepel, amin szemmel is jól láthatók a programot alkotó bitek.\cite{GBROM}
