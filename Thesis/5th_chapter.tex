\chapter{Joypad}

A PPU, azaz a Game Boy renderelésért felelõs grafikus alrendszere után itt az ideje a másik bemeneti modul, a \textit{joypad} implementálásának. Ahogy a PPU esetében is, úgy itt is elmondható, hogy nagyon fontos részegységrõl van szó, hiszen míg a renderelés eredményét "csak" \textit{látja} a kijelzõn a felhasználó, addig a \textit{joypad} gombjait megnyomva tud érdemben \textit{kommunikálni}, reagálni egyes helyzetekre, interakcióba lépni a hardverrel, vagy az emulátorral, amely ennek hatására változtatja a mûködését. Ha rossz a gomnyomás élménye, többedszerre sem érzékeli a hardver vagy emulátor a gombnyomást, esetleg késik a reakció a gombnyomásra, az mind-mind csalódottságot, és idegességet ébreszt a felhasználóban, mely következtében végsõ soron abbahagyja a játékot. Nagyon fontos tehát nem csak az eredeti hardver viselkedésének emulálása, hanem az is, hogy az emulálás élménye se maradjon el a Game Boy-étól.

\section{Technikai háttér és a \textit{Joypad Register}}

\begin{figure}[h!]%
    \centering
    \subfloat[]{\includegraphics[width=\textwidth/2-0.5cm]{./Resources/joypad_irl.eps}}%
    \qquad
    \subfloat[]{\includegraphics[width=\textwidth/2-0.5cm]{./Resources/joypad_sch.eps}}%
    \caption{\textit{A joypad gombjai (a), és sematikus kapcsolási (logikai) rajza (b)}}%
    \label{fig:joypad}%
\end{figure}

\noindent Ahogy a \ref{fig:joypad}-es ábrán látható, a Game Boy konzolon 8 darab gomb található. Ezeket szokás két nagyobb csoportra is bontani. Az egyik csoport a bal oldalon látható ún. \textit{D-pad}, amely látszólag egy nagy, plusz jel alakú gomb, az igazság azonban az, hogy 4 gombot olvaszt eggyé. A plusz jel négy ágának végein találhatóak meg az egyes irányokhoz rendelt gombok -- innen jön a \textit{D-pad} megnevezés is: \textit{Direction pad}, azaz \textit{irányító gomb}. Ennek segítségével tudjuk a bal kéz hüvelykujjával irányítani a játékonként változó elemet -- legyen az játszható karakter, Tetris-elem, stb.
\\ A másik, akciógombok csoportját a maradék gombok alkotják: \textit{A}, \textit{B}, \textit{Select} és \textit{Start}. Az elsõ kettõvel általában a játékon belüli akciókat, képességeket, funkciókat tudjuk aktiválni, míg az utóbbi kettõ a játék megszakítását, illetve a menükben való navigálást segíti.
\\ Ami a fenti, \ref{fig:joypad}-es ábra \textit{(b)} részét illeti: ez a kép mutatja be a Game Boy gombjainak kapcsolási rajzát. A karikák mutatják az egyes gombokat, mellettük a nevükkel, a vonalak pedig az õket összekötõ vezetékeket jelölik. Elsõ pillantásra bonyolultnak tûnhet, és fel\-me\-rül\-het bennünk, hogy miért nem két vonal (azaz vezeték) csatlakozik minden gombhoz -- ezekre egyfajta kapcsolóként gondolva, amelyek nyomásra zárják az áramkört. Nos, a Nintendo japán mérnökei ott spóroltak és optimalizáltak ahol tudtak -- ezt a gombok összekötésének megtervezésekor is szem elõtt tartották. A hétköznapi számítógép bil\-len\-tyû\-ze\-tek\-hez hasonló módon, egyfajta mátrixos elrendezést találtak ki, ezzel sok kábelt megspórolva. Ennek megfelelõen van tehát két kábelcsoport, az egyik a \textit{P10}, \textit{P11}, \textit{P12}, \textit{P13}, amelyek rendre egy-egy gombhoz vannak kötve mindkét gombcsoportban, a másik pedig a \textit{P14} és \textit{P15}, amelyek azt jelölik ki, hogy melyik gombcsoportról van éppen szó. Ennek mintájára mûködik az \texttt{0xFF00} memóriacímen található \textit{Joypad Register}, amely a mérnökök op\-ti\-ma\-li\-zá\-ci\-ó\-já\-nak hála egy bájtban képes eltárolni az összes gomb aktuális állapotát. Ennek a bájtnak a bitjei a következõket jelentik:

\begin{itemize}
  \item \textbf{7. - 6. bitek:} nincsenek használatban.
  \item \textbf{5. bit:} akciógomb kiválasztó bit, a \textit{P15}-ös vezetéknek felel meg. 0 érték esetén kerül kiválasztásra az \textit{A}, \textit{B}, \textit{Select} és \textit{Start} gombok csoportja.
  \item \textbf{4. bit:} iránygomb kiválasztó bit, a \textit{P14}-es vezetéknek felel meg. 0 érték esetén kerül kiválasztásra a \textit{D-pad} 4 darab iránygombja.
  \item \textbf{3. bit:} a 4. és 5. bitek értékétõl függõen a lefelé mutató iránygomb vagy a \textit{Start} gomb állapotát mutatja. Akkor tekintjük lenyomott állapotúnak, ha az értéke 0. A \textit{P13}-as vezetéknek felel meg.
  \item \textbf{2. bit:} a 4. és 5. bitek értékétõl függõen a felfelé mutató iránygomb vagy a \textit{Select} gomb állapotát mutatja. Akkor tekintjük lenyomott állapotúnak, ha az értéke 0. A \textit{P12}-es vezetéknek felel meg.
  \item \textbf{1. bit:} a 4. és 5. bitek értékétõl függõen a balra mutató iránygomb vagy a \textit{B} gomb állapotát mutatja. Akkor tekintjük lenyomott állapotúnak, ha az értéke 0. A \textit{P11}-es vezetéknek felel meg.
  \item \textbf{0. bit:} a 4. és 5. bitek értékétõl függõen a jobbra mutató iránygomb vagy az \textit{A} gomb állapotát mutatja. Akkor tekintjük lenyomott állapotúnak, ha az értéke 0. A \textit{P10}-es vezetéknek felel meg.
\end{itemize}

\noindent Érdekesség, hogy a fenti regiszter esetén minden esetben az jelenti a lenyomott állapotot, ha az adott bit értéke 0. Ebbõl az következik, hogy a megvalósítás során a regiszter esetében a \texttt{0xFF} érték lesz a \textit{default}, ezt kell frissíteni, és a megfelelõ biteket nullára állítani a megfelelõ mûködés eléréséhez. A következõ alfejezet fogja bemutatni, hogy mindezt hogyan lehet implementálni.

\section{Implementáció}

\begin{wrapfigure}{l!}[-1cm]{0.3\textwidth}
\begin{minted}[linenos]{asm}
  LD A,$20
  LD ($FF00),A 
  LD A,($FF00)
  LD A,($FF00) 
  CPL
  AND $0F
  SWAP A
  LD B,A
  LD A,$10
  LD ($FF00),A
  LD A,($FF00)
  LD A,($FF00)
  LD A,($FF00)
  LD A,($FF00)
  LD A,($FF00)
  LD A,($FF00)
  CPL
  AND $0F
  OR B
  LD B,A
  LD A,($FF8B)
  XOR B
  AND B
  LD ($FF8C),A
  LD A,B
  LD ($FF8B),A
  LD A,$30
  LD ($FF00),A
  RET
\end{minted}
\caption{\textit{A Ms. Pacman játék gombnyomás kezelõ kódja}}
\label{fig:pacman}
\end{wrapfigure}

\noindent \ref{fig:pacman}-es ábrán látható kód mutatja a Ms. Pacman játék kódjának egy részletét, amely a gombok lenyomását figyeli. Elõször betölti az \texttt{A} regiszterbe a \texttt{0x20} (0b00100000) értéket (1. sor), amellyel kijelöli a \textit{P14}-es csatlakozást, majd az \texttt{A}-t a \textit{Joypad Registerbe} tölti (2. sor). A \textit{Joypad Register} \texttt{A} regiszterbe történõ kétszeri betöltéssel egyfajta várakozást valósít meg (3-4. sor). Ezt követõen veszi az \texttt{A} regiszter komplementerét (5. sor), majd kinullázza az alsó 4 bitjét, felcseréli azt a felsõ 4 bittel, és elmenti a \texttt{B} regiszterbe (6-8. sor). A 9. sorban kijelöli a \textit{P15}-ös vezetéket, majd a 10.-ben eltárolja azt a \textit{Joypad Registerbe}. Ez után a 11.-tõl a 16. sorig várakozik, majd komplementálja \texttt{A}-t, veszi az alsó 4 bitjét, összevagyolja \texttt{B}-vel, és elmenti a \texttt{B}-be (17-20. sor). A következõ részben beolvassa a régi \textit{joypad} állapotot a memóriából, beállítja a jelenleg lenyomva tartott gombokat, elmenti az új állapotot reprezentáló bájtot, kiveszi a \textit{P14} és \textit{P15} kijelölését, \textit{reseteli} az állapot regisztert, majd visszatér a szubrutin (21-29. sor). \\
A fenti magyarázat azért volt fontos, mert rávilágít egy olyan viselkedésre, amely felett nagy valószínûséggel elsiklik a legtöbb emulátor fejlesztõ: ahhoz, hogy a lenyomott gomb kódját a regiszterbe írjuk, elõbb ellenõrizni kell, hogy a regiszter értéke szerint (amit a játék állít be) a játék mely gombcsoportra kíváncsi. Ezen kód értelmezésével tehát sok-sok órányi \textit{debuggolástól} kímélheti meg magát a fejlesztõ -- ez a többi területre is érvényes: érdemes, sõt, ajánlott a játékok kódját visszafejteni, és megnézni hogy mit hogyan csinálnak, mely memóriaterületekre írnak, hogyan kezelik a gomblenyomást, stb., hiszen végsõ soron az emulátor implementálásának "másik fele" a célhardverre írt játékok kódja: az egyik nem mûködik a másik nélkül. \\
Most, hogy már tisztában vagyunk a megfelelõ regiszterrel, illetve azzal, hogy a játékok hogyan veszik hasznát a gomboknak, hogyan detektálják azok lenyomását, érdemes megtervezni az emulátor gomblenyomásának kezelését. 

\subsection{Gombnyomás detektálás}

