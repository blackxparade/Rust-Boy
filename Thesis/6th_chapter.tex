\chapter{A program használata, tesztelés, és az elért eredmények}

Az elõzõ fejezetekben taglalt implementációs rész lezárult, ebben a fejezetben a kész emulátorról lesz szó -- annak használatáról, a futtatott tesztekrõl, és azok eredményeirõl. A fejezet végén egy összefoglaló részben a fejlesztés egészét számba véve fogom taglalni azt, hogy mi maradt ki, mit lehetett volna jobban csinálni, mi sikerült jól, vagy éppen kevésbé jól.

\section{A program használata, függõségek}

A program fejlesztéséhez Linux rendszert használtam, ennek ellenére viszont a program maga multiplatform -- Windows rendszeren is lefordítható és futtatható a megfelelõ fordító \textit{targetet} megadva. Az operációs rendszert tehát nem tekinthetjük függõségnek. A program fejlesztéséhez összesen két \textit{libraryt} használtam fel, a már taglalt \texttt{minifb} és \texttt{rand} könyv\-tá\-ra\-kat. \\
A \texttt{minifb} könyvtár esetén elmondható, hogy sajnos nem tartalmaz olyan megoldást, amellyel programkód segítségével be lehetne zárni egy ablakot. Ennek az lett a kö\-vet\-kez\-mé\-nye, hogy az eredeti terv szerint kapcsolókkal be-, és kikapcsolható \textit{debugger} és \textit{memory map} ablakokat ki kellett vennem a \textit{release} változatból, így azok nem elérhetõek. \\
A program használata nagyon egyszerû, parancssorból indítható. A parancssori indításhoz két paramétert kell megadni: 

\begin{itemize}
  \item az indítandó játék ROM-jának elérési útvonalát,
  \item a program skálázásának mértékét: ez lehet \texttt{X1}, \texttt{X2}, és \texttt{X4}.
\end{itemize}

\noindent Az emulátor mellé kell helyezni a Boot ROM-ot, enélkül a játékok ROM-jai nem fut\-tat\-ha\-tók. Egy példa az emulátor indítására:

\begin{minted}{bash}
                ./rust_boy rom/mario.gb -X4
\end{minted}

\noindent A skálázás segítségével nagyítani lehet az eredetileg 160$\times$144-es felbontáson, hogy job\-ban látszódjon mi történik az emulátoron -- az \texttt{X2}-es beállítással ez 320$\times$288-as, az \texttt{X4}-es beállítással pedig 640$\times$576 pixeles nagyságú lesz a renderelt kép. A nagyítás \textit{Nearest Neighbor} interpolációval történik, így nem mosódnak el a pixelek, minden tûéles marad. \\
A program indítását követõen elõször az eredeti hardverhez hasonlóan beúszik a Nintendo logó, majd betöltõdik a játék ROM-ja, ezzel egyidõben pedig az emulátor ablakának címsorában megjelenik a betöltött játék címe (amelyet a ROM \textit{headerjébõl} olvas ki a program).

\section{Tesztelés}

A Game Boy emulátorok tesztelésére többféle módszer létezik. Írhatunk saját magunk teszteket, amelyek a programmal együttmûködve ellenõrzik az egyes mûveletek utáni állapotot, viszont ebben az esetben az összes CPU mûveletet lefedõ teszteset halmazt kell írni, ami nagyon idõigényes. Természetesen emellé még külön oda kell figyelni az \textit{edge-casekre}, amik ritkán fordulnak ugyan elõ, de hektikus viselkedést idézhetnek elõ -- így már elsó hangon is minimum ezer tesztesetrõl beszélünk, ami borzasztó sok, fõleg egy fejlesztõre. Így hát maradnak az alternatív megoldások -- szerencsére léteznek a közösség által elfogadott, szinte tökélyre fejlesztett teszt romok, amelyek minden utasítást, regiszter viselkedést lefednek. Ezek nem csak azért jók, mert nem kell mi magunknak külön tesz\-te\-ket írni, hanem mert az egyes emulátorok összehasonlíthatóvá válnak, akár teljesítmény, vagy emuláció pontosság szempontjából is. Ilyen, nagyrészt a közösség által használt ROM kollekció a Blargg féle teszt ROM csomag. Az alábbi, \ref{fig:tests}-es ábrán láthatóak az egyes teszt ROM-ok eredményei. Fontos megjegyezni hogy egy ROM több tesztesetet is tartalmaz, a logikailag egybe tartozó utasítások vannak egy ROM-ba allokálva.

\begin{figure}[h!]%
    %\centering
    \subfloat[\textit{Speciális utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/01.eps}}
    \quad
    \subfloat[\textit{Megszakítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/02.eps}}
    \quad
    \subfloat[\texttt{SP}, \texttt{HL} \textit{utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/03.eps}}
    \quad
    \subfloat[\textit{Byte utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/04.eps}}
    \quad
    \subfloat[\textit{2 bájtos aritmetikai utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/05.eps}}
    \quad
    \subfloat[\textit{Betöltõ utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/06.eps}}
    \quad
    \subfloat[\textit{Eljárás utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/07.eps}}
    \quad
    \subfloat[\textit{Egyéb utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/08.eps}}
    \quad
    \subfloat[\textit{Regiszterek közötti utasítások}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/09.eps}}
    \quad
    \subfloat[\textit{Bitmûveleti u\-ta\-sí\-tá\-sok}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/10.eps}}
    \quad
    \subfloat[\textit{Utasítások me\-mó\-ri\-a\-cí\-mek\-kel}]{\includegraphics[width=0.22\textwidth, trim={0 0 0 2.5cm},clip]{./Resources/Tests/11.eps}}
    \caption{\textit{A Blargg-féle ROM tesztek és eredményeik}}
    \label{fig:tests}
\end{figure}

\noindent A ROM-ok futásuk során minden sikertelen teszt esetet kiírnak, néhol több, de inkább kevesebb hiba információval szolgálva. Az természetesen vitén felül áll, hogy ezekkel a ROM-okkal párhuzamosan ajánlott fejleszteni az emulátort, hiszen megmentheti a prog\-ra\-mo\-zót a késõbbi fejfájásoktól, amit az egyes utasításokban rejlõ bugok okoznak. Sikeres esetben a \textit{Passed} felirat jelenik meg a képernyõn. Mint a fenti ábra alapján is látszik, 11 darab teszt ROM van, összesen több száz teszt esettel. Az általam fejlesztett emulátor az összes elérhetõ Blargg-féle teszt ROM-ot sikeres eredménnyel zárja, egyetlen kivétellel -- a megszakításokkal kapcsolatos \texttt{02-interrupts} nevû teszt 4. teszt esetét nem tudja sikeresen elvégezni. Az emellé kapott hibaüzenet nem sokat segít -- a "\textit{Timer doesn't work}" üzenet egyszerûen nem igaz, az idõzítõk mûködnek. Sok kutatás után arra a kö\-vet\-kez\-te\-tés\-re jutottam, hogy a megszakítások idõzítése valószínûleg nem tökéletes, sok emulátor megbukik ezen a teszten, szigorú feltételeknek kell eleget tenni. Mivel sem magamtól, sem pedig az interneten nem találtam megoldást erre, így nem sikerült ezt kijavítani. Az egyes teszt ROM-ok által tartalmazott utasításokat a következõ felsorolás foglalja össze \cite{blargg}:

\begin{itemize}
  \item \textbf{\texttt{01-special:}} ez a teszt csomag a speciális ugrás és betöltõ mûveleteket, valamint a \mintinline{asm}{DAA} mûveletet ellenõrzi -- ez utóbbit az az \texttt{A} regiszter összes lehetséges állapotában és a \textit{flagek} minden lehetséges permutációjával. 
  \item \textbf{\texttt{02-interrupts:}} ezek a tesztek az \mintinline{asm}{EI}, \mintinline{asm}{DI} megszakítás engedélyezõ, illetve tiltó mûveleteket, a \mintinline{asm}{HALT} mûveletet, és a megszakítások idõzítéseit vizsgálják.
  \item \textbf{\texttt{03-op sp,hl:}} ez a teszt ROM olyan teszt eseteket tartalmaz, amelyek azon mûveleteket ellenõrzik, amelyek esetén vagy a \textit{Stack Pointer}, vagy a \textit{Stack Pointer} és a \texttt{HL} regiszter az operandus. Ezek lehetnek aritmatikai vagy betöltõ mûveletek is.
  \item \textbf{\texttt{04-op r,imm:}} ez a teszt olyan mûveletek helyességét ellenõrzi, amelyek e\-se\-té\-ben a második operandus egy konkrét bájt (nem memóriacímként megadott hivatkozás).
  \item \textbf{\texttt{05-op rp:}} ez a teszt csomag azokat a mûveleteket ellenõrzi, amelyek esetében 16 bites értékeken, azaz a \texttt{BC}, \texttt{DE}, \texttt{HL} regiszter párokon végzünk feladatokat. 
  \item \textbf{\texttt{06-ld r,r:}} ezzel a teszttel az összes -- regiszterek közti -- \mintinline{asm}{LD} mûveletet tudjuk ellenõrizni.
  \item \textbf{\texttt{07-jr,jp,call,ret,rst:}} ennek a teszthalmaznak a neve sokat elárul: el\-já\-rás utasításokat, vagyis ugrásokat, és feltételes ugrásokat, eljáráshívásokat, visszaté\-ré\-se\-ket, és a \textit{reset} mûveleteket ellenõrzi.
  \item \textbf{\texttt{08-misc instrs:}} ez a teszt csomag azon mûveletek helyességét ellenõrzi, amelyek semelyik más kategóriába sem fértek be: a \mintinline{asm}{PUSH}-t és \mintinline{asm}{POP}-ot, valamint a speciális betöltõ utasításokat.
  \item \textbf{\texttt{09-op r,r:}} ezzel a teszttel fõként az aritmetikai mûveleteket lehet el\-le\-nõ\-riz\-ni: az összes összeadás, kivonás, logikai mûvelet, forgatás, csere, eltolás variációra tartalmaz teszt esetet.
  \item \textbf{\texttt{10-bit ops:}} ez a teszt az összes bitmûveletet ellenõrzi: a bit lekéréseket, \textit{resetet}, \textit{setet} egyaránt.
  \item \textbf{\texttt{11-op a,(hl):}} ez a teszt ROM olyan teszt eseteket futtat le, amelyek azokat a processzor mûveleteket vizsgálják, ahol valamelyik operandus egy két bájtos (egy regiszterpárból kombinált) memóriacím, amely címen lévõ értékkel szeretnénk dolgozni.
\end{itemize}

\section{Az elért eredmények, összegzés}

Az emulátor fejlesztési projektúgy kezdõdött, hogy célként azt állítottam magam elé, hogy olyan emulátort fejlesztek, ami legalább a Boot ROM-ot tudja futtatni. Ezt jócskán sikerült túlszárnyalni. \\
Kijelenthetõ, hogy az általam fejlesztett emulátor (a megszakítások idõzítését kivéve) processzor mûveletei órajel pontosságúak, ami azt jelenti, hogy azok idõzítése megegyezik az eredeti konzolban található processzoréval -- ezt a \textit{Blargg}-féle teszt ROM-ok tesztelik minden utasítás esetén. A mûveletek eredményei kifogástalanok, az eredeti processzor mûködésével teljesen megegyeznek. Továbbá az alább látható \ref{fig:drmario}-es ábrán is meg\-fi\-gyel\-he\-tõ, hogy az imp\-le\-men\-tált PPU által renderelt kép megegyezik az eredeti hardver által kirajzolttal -- a \textit{Dr. Mario} mellett a többi, általam tesztelt játék esetén is ezt tapasztaltam.

\begin{figure}[h!]%
    %\centering
    \subfloat[\textit{Eredeti Nintendo Game Boy}]{\includegraphics[width=0.48\textwidth]{./Resources/drmario_dmg.eps}}
    \quad
    \subfloat[\textit{Az általam fejlesztett emulátor, a Rust Boy}]{\includegraphics[width=0.48\textwidth]{./Resources/drmario_emu1.eps}}
    \caption{\textit{A Dr. Mario játék emulálásának összhasonlítása az eredetivel}}
    \label{fig:drmario}
\end{figure}

\noindent A teszt ROM-ok segítségével lehetségessé válik az egyes emulátorok összhasonlítása pontossági szemszögbõl -- két emulátor között az tekinthetõ pontosabbnak, amelyik több \textit{Blargg} teszten megy át. A legjobb, és legnépszerûbb emulátorok teszt ROM-ok alapján való összehasonlítását a következõ táblázat mutatja \cite{testroms}:

\begin{table}[h!]
  \centering
  {\renewcommand{\arraystretch}{1.3}
  \begin{tabu}{ |>{\columncolor{GameBoyBlue}}l|[2pt]l|} 
   \hline
   \textbf{Rust Boy} & \textbf{10/11 teszt sikeres, 2./4. teszt sikertelen} \\ \hline
   BGB & 11/11 teszt sikeres \\ \hline
   Gambatte & 11/11 teszt sikeres \\ \hline
   KiGB & 9/11 teszt sikeres, 3./1. és 5./1. tesztek sikertelenek \\ \hline
   MESS & 11/11 teszt sikeres \\ \hline
   no\$gmb & 9/11 teszt sikeres, 3./1. és 5./1. tesztek sikertelenek \\ \hline
   VBA & 11/11 teszt sikeres \\ \hline
  \end{tabu}}
  \caption{\textit{Emulátorok pontossági összehasonlítása a tesztek alapján}}
  \label{table:1}
\end{table}

\noindent A fentiek alapján tehát látható, hogy a diplomamunkaként fejlesztett \textit{Rust Boy} felveszi a versenyt a népszerû emulátorokkal, sõt, némelyiknél pontosabb emulálást is kínál. A sokak által használt emulátorok többsége azért a tesztek alapján hibátlan, viszont az egy sikertelen tesztnyi lemaradás nem tekinthetõ nagy különbségnek. \\
Az emulátor sebessége a fejlesztés elõtt tervezett 60 FPS-nek megfelel, folyékony, a\-ka\-do\-zás\-men\-tes a kép, a billentyûleütésekre is azonnal reagál a program -- ezzel együtt a játékélmény az eredeti konzolnak megfelelõ. \\
Ami a hiányosságokat illeti -- két dologról lehet említést tenni. Az elsõ, és kisebb el\-ma\-ra\-dás a különbözõ MBC technológiák és megoldások adaptálása, amelyek lehetõvé teszik a 32kB-nál nagyobb méretû játékok futtatását az emulátoron. Természetesen enélkül is játszhatóak játékok, viszont csak azok, amelyeknek mérete nem haladja meg az elõbb említett korlátot. Az MBC különféle verzióinak implementálása azért maradt el, mert egyrészt sok van belõlük (5 darab), és mindegyik máshogy mûködik, így érthetõ módon a fejlesztésük nagyon sokáig tartott volna. \\
A másik hiányzó modul a hang. A \textit{sound processing} részt a fejlesztés elejétõl kezdve az implementáció legvégére hagytam, majd miután komolyabban utánanéztem annak, hogy a Game Boy-ban milyen bonyolult 4 csatornás, sztereo hanggenerálás van, úgy határoztam hogy ehelyett inkább a sokkal elemibb, alapvetõbb funkciók fejlesztésére szánom az erõforrásokat. A hangok emulációja nélkül is mûködik az emulátor, persze az élmény nem egyezik meg az eredeti hardverével, viszont a hangfeldolgozás témaköre nagyon bonyolult, szinte mégegy teljes diplomamunkát is kitenne, így a lehetõségekhez mérten próbáltam a fél évnyi fejlesztési idõt enélkül a modul nélkül végigvinni. A jövõben mindenképpen megpróbálom megvalósítani az emulátor számára ezt a modult, egyrészt a hangfeldolgozás területén való tapasztalatlanságom -- és ebbõl kifolyólag a tapasztalat\-gyûj\-tés -- és a teljesség igénye miatt.\\
Mindent összevetve nagyon hosszú, bonyolult, de annál tanulságosabb úton vagyok túl. Ez volt a második projektem a \textit{Rust} programozási nyelv használatával, soha nem írtam még ekkora programot -- a refaktorálások után összesen \url{~}11000 sor kóddal sikerült imp\-le\-men\-tál\-ni az emulátort. Nem csak a kódsorok mennyiségét tekintve, hanem strukturálisan is nagy rendszert kellett megvalósítani, amit egyben fejben tartani embert próbáló feladat -- bebizonyosodott számomra hogy az emulátorfejlesztés közel sem gyalog galopp. Ha most újrakezdeném természetesen már teljesen máshogy csinálnám az egészet, és talán a fenti szám háromnegyedébõl megoldanám a projekt fejlesztését. A megszámlálhatatlan órányi kutatás és \textit{debuggolás} egyrészt megtanított rá, hogy sokkal jobban értékeljem a "régmúlt" digitális eszközeit, hiszen nagyon sok esetben rengeteg okos trükköt kellett alkalmazni a technológia fejletlensége miatt, vagy éppen más okokból. A gépközeli, \textit{as\-sem\-bly} és \textit{bytecode} programozásba is széleskörû belátást tudtam nyerni, amit sok te\-rü\-le\-ten tudok majd alkalmazni a továbbiakban. \textit{Ha visszamehetnék az idõben, és újra diplomamunka témát választhatnék, semmin sem változtatnék.}